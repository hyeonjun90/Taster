<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC '-//ibatis.apache.org//DTD Sql Map 2.0//EN' 'http://ibatis.apache.org/dtd/sql-map-2.dtd'>
<sqlMap>

	
	<!--신규 식당  등록에서 사용할 현재시간에서 한달까지의 전채검색-->
	<sql id= "newShop-select-all">
	 	select * from shop s1 inner join review r1 on r1.shop_idx = s1.shop_idx
        where <![CDATA[shop_regDate > add_months(sysdate, -1)]]> order by shop_idx desc                         
	</sql>

	
	<select id="foodsMenuList" resultClass="bean.FoodsMenuListBean" parameterClass="HashMap" remapResults="true">
		select * from ( 
		 	select shop_idx, shop_name, shop_addr1, shop_addr2, shop_addr3, shop_addr4, file_savname, rownum rnum,
    					r_content, member_nicname, member_image, avg_r_score 
    		from (
			 		  select shop_idx, shop_name, shop_addr1, shop_addr2, shop_addr3, shop_addr4, file_savname, 
						  (select r_content from (select r_content from review r1 where s.shop_idx=r1.shop_idx)
						  	 where <![CDATA[rownum<2]]>) as r_content,
						  (select member_nicname from 
							  (select  member_nicname from member m1 inner join review r1 on r1.member_id=m1.member_id
							    where m1.member_id=r1.member_id and r1.shop_idx=s.shop_idx)
						   where <![CDATA[rownum<2]]>) as member_nicname,
						  (select member_image from 
							  (select  member_image from member m1 inner join review r1 on r1.member_id=m1.member_id
							    where m1.member_id=r1.member_id and r1.shop_idx=s.shop_idx)
						   where <![CDATA[rownum<2]]>) as member_image, 
						  (select ROUND(AVG(r1.r_score),1) from shop s1 
						  				inner join review r1 on r1.shop_idx = s1.shop_idx 
						  				where r1.SHOP_IDX=s.SHOP_IDX) as avg_r_score
					    from shop s order by avg_r_score desc, shop_idx desc) 
			where <![CDATA[rownum<=#pageSize#]]>)
		where <![CDATA[rnum>#beforeSize#]]>
	</select>

	
	<select id="foodsMenuListCount" resultClass="Integer">
		select count(*) from shop 
	</select>
	
	<!-- 식당 전체 평균 조인  -->
	<select id="newShop-selectAll"  resultClass="bean.FoodsNewListBean" remapResults="true">
		select shop_idx, shop_name, shop_addr1, shop_addr2, shop_addr3, shop_addr4, file_savname,
		(select r_content from (select r_content from review r1 where s.shop_idx=r1.shop_idx)
		  	 where <![CDATA[rownum<2]]>) as r_content,
		  (select member_nicname from 
			  (select  member_nicname from member m1 inner join review r1 on r1.member_id=m1.member_id
			    where m1.member_id=r1.member_id and r1.shop_idx=s.shop_idx)
		   where <![CDATA[rownum<2]]>) as member_nicname,
		  (select member_image from 
			  (select  member_image from member m1 inner join review r1 on r1.member_id=m1.member_id
			    where m1.member_id=r1.member_id and r1.shop_idx=s.shop_idx)
		   where <![CDATA[rownum<2]]>) as member_image, 
		(select ROUND(AVG(r1.r_score),1) from shop s1 
		  				inner join review r1 on r1.shop_idx = s1.shop_idx 
		  				where r1.SHOP_IDX=s.SHOP_IDX) as avg_r_score
		from shop s where <![CDATA[shop_regDate > add_months(sysdate, -1)]]>
	</select>
	
	
	
	
	<!-- 식당 상세페이지 쿼리문 -->
	<!--  -->
	<select id="foodsDetail" parameterClass="int" resultClass="bean.FoodsDetailBean">
		SELECT shop_idx, shop_name, shop_tel, shop_kind, shop_addr1, shop_addr2, shop_addr3, shop_addr4, shop_price, shop_holiday, shop_readCount, shop_regDate, file_savname
		FROM SHOP WHERE shop_idx = #shop_idx#
	</select>
	
	
	<!-- 코멘트 리스트 -->
	<select id="reviewList" parameterClass="int" resultClass="bean.FoodsDetailBean">
		SELECT  review_idx, r_title, r_content, r_pungga, r_image, r_regdate, member_nicname, member_image
							 FROM review r left join member m on r.member_id=m.member_id
							 where r.shop_idx=#shop_idx#
							 ORDER BY r.review_idx desc 

		
		<!-- SELECT * FROM (
					SELECT review_idx, r_title, r_content, r_pungga, r_image, r_regdate, rownum rnum, 
							member_nicname, member_image 
					FROM (SELECT  review_idx, r_title, r_content, r_pungga, r_image, r_regdate, 
							(SELECT member_nicname FROM 
							  		(SELECT member_nicname FROM member WHERE member.member_id=r.member_id)  
							   where <![CDATA[rownum<2]]>) AS member_nicname,
							 (SELECT member_image FROM 
							 		(SELECT  member_image FROM member WHERE member.member_id=r.member_id)
							 WHERE <![CDATA[rownum<2]]>) AS member_image
							 FROM review r ORDER BY review_idx desc) 
					WHERE <![CDATA[rownum<=#pageSize#]]>)
		WHERE <![CDATA[rnum>#beforeSize#]]> -->
	</select>
	
	
</sqlMap>












